#!/bin/sh

# Attempts to append the JIRA ticket number generated from the branch.

FORMAT='[%s]'

matches_jira_format() {
  printf "$1" | grep -Eq '^(.+/)?[^-]+-[^-]+.*$'
}

get_ticket_from_branch() {
  local branch="${1}"
  printf "${branch}" |\
    sed 's/\(.\+\/\)\?\([^-]\+-[0-9]\+\).*/\2/g' |\
    tr '[a-z]' '[A-Z]'
}

format_ticket() {
  local ticket="${1}"
  printf "${FORMAT}" "${ticket}"
}


branch="$(git symbolic-ref --short HEAD)"
if matches_jira_format "${branch}"; then
  ticket="$(get_ticket_from_branch ${branch})"
  sed -i.bak -e "1s/^/$(format_ticket ${ticket}) /" "$1"
fi
