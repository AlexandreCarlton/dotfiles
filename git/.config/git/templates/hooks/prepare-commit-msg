#!/bin/sh

# Attempts to prepend the JIRA ticket number generated from the branch.

# Format of ticket number; \1 represents the ticket
TICKET_FORMAT='[\1]'

# Arguments given to script
COMMIT_MESSAGE_FILEPATH="${1}"
COMMIT_TYPE="${2}"
COMMIT_SHA="${3}"


# Returns empty string on failure
get_ticket_from_branch() {
  local branch="${1}"
  local branch_pattern='^(\w+/)?(\w+-[0-9]+).*$'
  local ticket_dest='\2'
  printf '%s' "${branch}" |\
    sed --regexp-extended --quiet "s:${branch_pattern}:${ticket_dest}:p" |\
    tr '[:lower:]' '[:upper:]'
}

format_ticket() {
  local ticket="${1}"
  printf '%s' "${ticket}" |\
    sed --regexp-extended "s/(.*)/${TICKET_FORMAT}/"
}

insert_ticket() {
  local filepath="${1}"
  local branch="$(git symbolic-ref --short HEAD)"
  local ticket="$(get_ticket_from_branch "${branch}")"
  if [ -n "${ticket}" ]; then
    sed --in-place='.bak' "1s/^/$(format_ticket "${ticket}") /" "${filepath}"
  fi
}

insert_ticket "${COMMIT_MESSAGE_FILEPATH}"
