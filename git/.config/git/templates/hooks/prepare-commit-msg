#!/bin/sh

# Attempts to prepend the JIRA ticket number generated from the branch.

# Format of ticket number
FORMAT='[%s]'

# Pattern used to match ticket from branch
PATTERN='^(\w+/)?(\w+-[0-9]+).*$'

# Location of ticket grouped in the above regex
LOCATION='2'

matches_jira_format() {
  printf "%s" "$1" | grep --extended-regexp --quiet "${PATTERN}"
}

get_ticket_from_branch() {
  local branch="${1}"
  printf "%s" "${branch}" |\
    sed --regexp-extended "s:${PATTERN}:\\${LOCATION}:g" |\
    tr '[a-z]' '[A-Z]'
}

format_ticket() {
  local ticket="${1}"
  printf "${FORMAT}" "${ticket}"
}


branch="$(git symbolic-ref --short HEAD)"
if matches_jira_format "${branch}"; then
  ticket="$(get_ticket_from_branch "${branch}")"
  sed --in-place='.bak' --expression="1s/^/$(format_ticket "${ticket}") /" "$1"
fi
